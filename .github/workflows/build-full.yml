name: Build Full Project (with dependency check)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'GameServer/**'
      - '.github/workflows/**'

jobs:
  build-check:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1
      
    - name: Display project structure
      run: |
        Write-Host "=== Project Structure ===" -ForegroundColor Cyan
        Get-ChildItem -Recurse -Directory -Depth 2 | Select-Object FullName
        Write-Host ""
        Write-Host "=== Solution Files ===" -ForegroundColor Cyan
        Get-ChildItem -Recurse -Filter "*.sln" | Select-Object FullName
      shell: pwsh
      
    - name: Check dependencies
      run: |
        Write-Host "=== Dependency Check ===" -ForegroundColor Cyan
        $deps = @(
          @{Name="CrossRoads"; Path="..\Cryptic\CrossRoads"},
          @{Name="Core"; Path="..\Cryptic\Core"},
          @{Name="libs"; Path="..\libs"},
          @{Name="PropertySheets"; Path="..\PropertySheets"},
          @{Name="utilities"; Path="..\utilities\bin\structparser.exe"}
        )
        
        foreach ($dep in $deps) {
          if (Test-Path $dep.Path) {
            Write-Host "✅ $($dep.Name): Found" -ForegroundColor Green
          } else {
            Write-Host "❌ $($dep.Name): Missing" -ForegroundColor Red
          }
        }
      shell: pwsh
      
    - name: Attempt build
      run: |
        Write-Host "=== Attempting Build ===" -ForegroundColor Cyan
        $solutionPath = "GameServer\NNOGameServer.sln"
        
        if (-not (Test-Path $solutionPath)) {
          Write-Host "Solution file not found: $solutionPath" -ForegroundColor Red
          exit 1
        }
        
        Write-Host "Building: $solutionPath" -ForegroundColor Yellow
        msbuild $solutionPath `
          /p:Configuration=Debug `
          /p:Platform=Win32 `
          /t:Build `
          /v:detailed `
          /nologo `
          /fl `
          /flp:logfile=build.log;verbosity=detailed
      shell: pwsh
      continue-on-error: true
      
    - name: Upload build log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log
        path: build.log
        if-no-files-found: ignore
        
    - name: Build summary
      if: always()
      run: |
        Write-Host "=== Build Summary ===" -ForegroundColor Cyan
        if (Test-Path "build.log") {
          Write-Host "Build log generated. Check artifacts for details."
          $errors = Select-String -Path "build.log" -Pattern "error" -CaseSensitive:$false
          if ($errors) {
            Write-Host "Found errors in build log:" -ForegroundColor Red
            $errors | Select-Object -First 10 | ForEach-Object { Write-Host "  $($_.Line)" }
          }
        }
        
        if ($LASTEXITCODE -eq 0) {
          Write-Host "✅ Build completed successfully!" -ForegroundColor Green
        } else {
          Write-Host "❌ Build failed (exit code: $LASTEXITCODE)" -ForegroundColor Red
          Write-Host "This is expected if dependencies are missing." -ForegroundColor Yellow
        }
      shell: pwsh

