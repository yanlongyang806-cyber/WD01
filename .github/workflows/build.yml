name: Build Night GameServer

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  BUILD_CONFIGURATION: Debug
  BUILD_PLATFORM: Win32

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1
      
    - name: Display environment
      run: |
        Write-Host "=== Build Environment ===" -ForegroundColor Cyan
        Write-Host "Runner OS: $env:RUNNER_OS" -ForegroundColor Gray
        Write-Host "Workspace: $env:GITHUB_WORKSPACE" -ForegroundColor Gray
        Write-Host "Build Configuration: $env:BUILD_CONFIGURATION" -ForegroundColor Gray
        Write-Host "Build Platform: $env:BUILD_PLATFORM" -ForegroundColor Gray
      shell: pwsh
      
    - name: Check project structure
      run: |
        Write-Host "=== Project Structure ===" -ForegroundColor Cyan
        Get-Location
        Get-ChildItem -Directory | Select-Object Name | Format-Table -AutoSize
        
        Write-Host "`n=== Solution Files ===" -ForegroundColor Cyan
        Get-ChildItem -Recurse -Filter "*.sln" -ErrorAction SilentlyContinue | 
          Select-Object FullName | 
          ForEach-Object { Write-Host "  $($_.FullName)" -ForegroundColor Gray }
      shell: pwsh
      
    - name: Check dependencies
      id: check-deps
      run: |
        Write-Host "=== Dependency Check ===" -ForegroundColor Cyan
        $deps = @{}
        $missingDeps = @()
        
        # Check for CrossRoads
        $crossRoadsPaths = @(
          "..\Cryptic\CrossRoads",
          "..\CrossRoads",
          "Cryptic\CrossRoads",
          "CrossRoads"
        )
        foreach ($path in $crossRoadsPaths) {
          if (Test-Path $path) {
            $deps["CrossRoads"] = $path
            Write-Host "‚úÖ CrossRoads found at: $path" -ForegroundColor Green
            break
          }
        }
        if (-not $deps["CrossRoads"]) {
          Write-Host "‚ùå CrossRoads not found" -ForegroundColor Red
          $missingDeps += "CrossRoads"
        }
        
        # Check for Core
        $corePaths = @(
          "..\Cryptic\Core",
          "..\core",
          "Cryptic\Core",
          "core"
        )
        foreach ($path in $corePaths) {
          if (Test-Path $path) {
            $deps["Core"] = $path
            Write-Host "‚úÖ Core found at: $path" -ForegroundColor Green
            break
          }
        }
        if (-not $deps["Core"]) {
          Write-Host "‚ùå Core not found" -ForegroundColor Red
          $missingDeps += "Core"
        }
        
        # Check for libs
        $libsPaths = @(
          "..\libs",
          "libs"
        )
        foreach ($path in $libsPaths) {
          if (Test-Path $path) {
            $deps["libs"] = $path
            Write-Host "‚úÖ libs found at: $path" -ForegroundColor Green
            break
          }
        }
        if (-not $deps["libs"]) {
          Write-Host "‚ö†Ô∏è libs not found (may be optional)" -ForegroundColor Yellow
          $missingDeps += "libs"
        }
        
        # Check for PropertySheets
        $propsPaths = @(
          "..\PropertySheets",
          "PropertySheets"
        )
        foreach ($path in $propsPaths) {
          if (Test-Path $path) {
            $deps["PropertySheets"] = $path
            Write-Host "‚úÖ PropertySheets found at: $path" -ForegroundColor Green
            break
          }
        }
        if (-not $deps["PropertySheets"]) {
          Write-Host "‚ö†Ô∏è PropertySheets not found (may cause build errors)" -ForegroundColor Yellow
          $missingDeps += "PropertySheets"
        }
        
        # Check for structparser
        $structparserPaths = @(
          "..\utilities\bin\structparser.exe",
          "utilities\bin\structparser.exe",
          "..\..\utilities\bin\structparser.exe"
        )
        foreach ($path in $structparserPaths) {
          if (Test-Path $path) {
            $deps["structparser"] = $path
            Write-Host "‚úÖ structparser.exe found at: $path" -ForegroundColor Green
            break
          }
        }
        if (-not $deps["structparser"]) {
          Write-Host "‚ö†Ô∏è structparser.exe not found (pre-build step may fail)" -ForegroundColor Yellow
          $missingDeps += "structparser"
        }
        
        # Output for next steps
        $hasRequired = ($deps["CrossRoads"] -and $deps["Core"])
        Write-Host "`n=== Dependency Summary ===" -ForegroundColor Cyan
        Write-Host "Required dependencies available: $hasRequired" -ForegroundColor $(if ($hasRequired) { "Green" } else { "Red" })
        
        if ($missingDeps.Count -gt 0) {
          Write-Host "`nMissing dependencies:" -ForegroundColor Red
          $missingDeps | ForEach-Object { Write-Host "  - $_" -ForegroundColor Red }
        }
        
        echo "has_required=$hasRequired" >> $env:GITHUB_OUTPUT
        echo "missing_deps=$($missingDeps -join ',')" >> $env:GITHUB_OUTPUT
      shell: pwsh
      continue-on-error: true
      
    - name: Create dependency links
      if: steps.check-deps.outputs.has_required == 'false'
      run: |
        Write-Host "=== Attempting to create dependency links ===" -ForegroundColor Cyan
        
        # Try to create links if dependencies exist in different locations
        $basePath = Get-Location
        
        # CrossRoads
        if (Test-Path "..\Cryptic\CrossRoads") {
          if (-not (Test-Path "..\CrossRoads")) {
            try {
              New-Item -ItemType SymbolicLink -Path "..\CrossRoads" -Target "..\Cryptic\CrossRoads" -Force | Out-Null
              Write-Host "‚úÖ Created CrossRoads link" -ForegroundColor Green
            } catch {
              Write-Host "‚ö†Ô∏è Could not create CrossRoads link: $_" -ForegroundColor Yellow
            }
          }
        }
        
        # Core
        if (Test-Path "..\Cryptic\Core") {
          if (-not (Test-Path "..\core")) {
            try {
              New-Item -ItemType SymbolicLink -Path "..\core" -Target "..\Cryptic\Core" -Force | Out-Null
              Write-Host "‚úÖ Created core link" -ForegroundColor Green
            } catch {
              Write-Host "‚ö†Ô∏è Could not create core link: $_" -ForegroundColor Yellow
            }
          }
        }
      shell: pwsh
      continue-on-error: true
      
    - name: Validate solution file
      run: |
        Write-Host "=== Validating Solution File ===" -ForegroundColor Cyan
        $solutionPath = "GameServer\NNOGameServer.sln"
        
        if (-not (Test-Path $solutionPath)) {
          Write-Host "‚ùå Solution file not found: $solutionPath" -ForegroundColor Red
          Write-Host "Available solution files:" -ForegroundColor Yellow
          Get-ChildItem -Recurse -Filter "*.sln" -ErrorAction SilentlyContinue | 
            Select-Object FullName | 
            ForEach-Object { Write-Host "  $($_.FullName)" -ForegroundColor Gray }
          exit 1
        }
        
        Write-Host "‚úÖ Solution file found: $solutionPath" -ForegroundColor Green
        
        # Check if solution file is valid
        $content = Get-Content $solutionPath -Raw
        if ($content -match "Microsoft Visual Studio Solution") {
          Write-Host "‚úÖ Solution file format is valid" -ForegroundColor Green
        } else {
          Write-Host "‚ö†Ô∏è Solution file format may be invalid" -ForegroundColor Yellow
        }
      shell: pwsh
      
    - name: Build GameServer
      id: build
      run: |
        Write-Host "=== Building GameServer ===" -ForegroundColor Cyan
        $solutionPath = "GameServer\NNOGameServer.sln"
        $buildLog = "build.log"
        
        Write-Host "Solution: $solutionPath" -ForegroundColor Gray
        Write-Host "Configuration: $env:BUILD_CONFIGURATION" -ForegroundColor Gray
        Write-Host "Platform: $env:BUILD_PLATFORM" -ForegroundColor Gray
        Write-Host ""
        
        # Check dependencies before building
        if ("${{ steps.check-deps.outputs.has_required }}" -ne "true") {
          Write-Host "‚ö†Ô∏è WARNING: Required dependencies are missing!" -ForegroundColor Yellow
          Write-Host "Build will likely fail due to missing dependencies:" -ForegroundColor Yellow
          Write-Host "${{ steps.check-deps.outputs.missing_deps }}" -ForegroundColor Red
          Write-Host ""
          Write-Host "Attempting build anyway to capture error details..." -ForegroundColor Cyan
        }
        
        # Build with detailed logging
        $buildOutput = ""
        try {
          msbuild $solutionPath `
            /p:Configuration=$env:BUILD_CONFIGURATION `
            /p:Platform=$env:BUILD_PLATFORM `
            /t:Build `
            /v:detailed `
            /nologo `
            /fl `
            /flp:logfile=$buildLog;verbosity=detailed `
            2>&1 | Tee-Object -Variable buildOutput
        
          $buildExitCode = $LASTEXITCODE
        } catch {
          Write-Host "Build command failed: $_" -ForegroundColor Red
          $buildExitCode = 1
        }
        
        # Analyze build output
        Write-Host "`n=== Build Analysis ===" -ForegroundColor Cyan
        
        if (Test-Path $buildLog) {
          $errorCount = 0
          $warningCount = 0
          
          # Count errors
          $errors = Select-String -Path $buildLog -Pattern "error\s+(CS|C\d{4}|LNK|MSB)" -CaseSensitive:$false
          if ($errors) {
            $errorCount = $errors.Count
            Write-Host "‚ùå Found $errorCount error(s)" -ForegroundColor Red
            Write-Host "`nFirst 15 errors:" -ForegroundColor Yellow
            $errors | Select-Object -First 15 | ForEach-Object {
              Write-Host "  $($_.Line.Trim())" -ForegroundColor Red
            }
          } else {
            Write-Host "‚úÖ No compilation errors found in log" -ForegroundColor Green
          }
          
          # Count warnings
          $warnings = Select-String -Path $buildLog -Pattern "warning\s+(CS|C\d{4})" -CaseSensitive:$false
          if ($warnings) {
            $warningCount = $warnings.Count
            Write-Host "‚ö†Ô∏è Found $warningCount warning(s)" -ForegroundColor Yellow
          }
          
          # Check for common dependency errors
          $depErrors = Select-String -Path $buildLog -Pattern "cannot open include file|cannot open source file|unresolved external|PropertySheets" -CaseSensitive:$false
          if ($depErrors) {
            Write-Host "`nüîç Dependency-related errors detected:" -ForegroundColor Yellow
            $depErrors | Select-Object -First 10 | ForEach-Object {
              Write-Host "  $($_.Line.Trim())" -ForegroundColor Yellow
            }
          }
        } else {
          Write-Host "‚ö†Ô∏è Build log file not found" -ForegroundColor Yellow
        }
        
        # Check for output files
        Write-Host "`n=== Checking for Build Outputs ===" -ForegroundColor Cyan
        $outputDirs = @(
          "GameServer\Debug",
          "GameServer\bin",
          "GameServer\x64\Debug",
          "GameServer\Win32\Debug",
          "GameServer\Debug\GameServer.exe",
          "GameServer\bin\GameServer.exe"
        )
        
        $foundOutputs = $false
        foreach ($dir in $outputDirs) {
          if (Test-Path $dir) {
            if ((Get-Item $dir) -is [System.IO.DirectoryInfo]) {
              $files = Get-ChildItem $dir -Recurse -File -ErrorAction SilentlyContinue
              if ($files) {
                Write-Host "‚úÖ Found output directory: $dir ($($files.Count) files)" -ForegroundColor Green
                $files | Select-Object -First 5 Name, Length | Format-Table -AutoSize
                $foundOutputs = $true
              }
            } else {
              Write-Host "‚úÖ Found output file: $dir" -ForegroundColor Green
              $foundOutputs = $true
            }
          }
        }
        
        if (-not $foundOutputs) {
          Write-Host "‚ùå No build output files found!" -ForegroundColor Red
          Write-Host "This indicates the build did not produce any executables." -ForegroundColor Yellow
        }
        
        echo "exit_code=$buildExitCode" >> $env:GITHUB_OUTPUT
        echo "found_outputs=$foundOutputs" >> $env:GITHUB_OUTPUT
        echo "error_count=$errorCount" >> $env:GITHUB_OUTPUT
        
        # Exit with error if build failed
        if ($buildExitCode -ne 0) {
          Write-Host "`n‚ùå Build failed with exit code: $buildExitCode" -ForegroundColor Red
          exit $buildExitCode
        }
        
        if (-not $foundOutputs) {
          Write-Host "`n‚ùå Build completed but no output files found!" -ForegroundColor Red
          exit 1
        }
      shell: pwsh
      continue-on-error: true
      
    - name: Find build outputs
      if: always()
      run: |
        Write-Host "=== Searching for Build Outputs ===" -ForegroundColor Cyan
        
        $outputDirs = @(
          "GameServer\Debug",
          "GameServer\bin",
          "GameServer\x64\Debug",
          "GameServer\Win32\Debug"
        )
        
        $foundOutputs = $false
        foreach ($dir in $outputDirs) {
          if (Test-Path $dir) {
            Write-Host "‚úÖ Found output directory: $dir" -ForegroundColor Green
            $files = Get-ChildItem $dir -Recurse -File -ErrorAction SilentlyContinue
            if ($files) {
              Write-Host "  Files found:" -ForegroundColor Gray
              $files | Select-Object -First 10 Name, @{Name="Size(KB)";Expression={[math]::Round($_.Length/1KB,2)}} | Format-Table -AutoSize
              $foundOutputs = $true
            }
          }
        }
        
        if (-not $foundOutputs) {
          Write-Host "‚ùå No build output directories or files found!" -ForegroundColor Red
          Write-Host "`nThis usually means:" -ForegroundColor Yellow
          Write-Host "  1. Build failed due to missing dependencies" -ForegroundColor Gray
          Write-Host "  2. Build failed due to compilation errors" -ForegroundColor Gray
          Write-Host "  3. Output directory is in a different location" -ForegroundColor Gray
        }
      shell: pwsh
      
    - name: Upload build artifacts
      if: steps.build.outputs.found_outputs == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: build-outputs
        path: |
          GameServer/Debug/
          GameServer/bin/
          GameServer/x64/Debug/
          GameServer/Win32/Debug/
        if-no-files-found: error
        
    - name: Upload build log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log
        path: build.log
        if-no-files-found: ignore
        retention-days: 30
        
    - name: Build summary
      if: always()
      run: |
        Write-Host "`n=== Build Summary ===" -ForegroundColor Cyan
        
        $exitCode = "${{ steps.build.outputs.exit_code }}"
        $foundOutputs = "${{ steps.build.outputs.found_outputs }}"
        $errorCount = "${{ steps.build.outputs.error_count }}"
        
        Write-Host "Exit Code: $exitCode" -ForegroundColor $(if ($exitCode -eq "0") { "Green" } else { "Red" })
        Write-Host "Outputs Found: $foundOutputs" -ForegroundColor $(if ($foundOutputs -eq "true") { "Green" } else { "Red" })
        Write-Host "Error Count: $errorCount" -ForegroundColor $(if ($errorCount -eq "0") { "Green" } else { "Red" })
        
        if ($exitCode -eq "0" -and $foundOutputs -eq "true") {
          Write-Host "`n‚úÖ Build completed successfully!" -ForegroundColor Green
          Write-Host "Check artifacts for build outputs." -ForegroundColor Gray
        } else {
          Write-Host "`n‚ùå Build failed or no outputs generated" -ForegroundColor Red
          Write-Host "`nCommon reasons:" -ForegroundColor Yellow
          Write-Host "  1. Missing dependencies (CrossRoads, Core, libs)" -ForegroundColor Gray
          Write-Host "  2. Missing PropertySheets configuration files" -ForegroundColor Gray
          Write-Host "  3. Missing structparser.exe pre-build tool" -ForegroundColor Gray
          Write-Host "  4. Missing required header files or libraries" -ForegroundColor Gray
          Write-Host "  5. Compilation errors in source code" -ForegroundColor Gray
          Write-Host "`nCheck build.log artifact for detailed error information." -ForegroundColor Cyan
          Write-Host "Download the build-log artifact to see full error details." -ForegroundColor Cyan
        }
      shell: pwsh
